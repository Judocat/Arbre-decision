<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Arbre de D√©cision</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background: #f5f5f5; color: #333; }
        .header { background: #00843d; color: white; padding: 20px; text-align: center; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .container { max-width: 1200px; margin: 20px auto; padding: 0 20px; }
        .panel { background: white; border-radius: 8px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin-bottom: 20px; }
        .panel h2 { color: #00843d; margin-bottom: 15px; border-bottom: 2px solid #00843d; padding-bottom: 10px; }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }
        .login { max-width: 400px; margin: 50px auto; }
        input, textarea { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; margin-bottom: 10px; font-family: inherit; }
        textarea { min-height: 80px; resize: vertical; }
        button { padding: 10px 20px; background: #00843d; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 500; }
        button:hover { background: #006b32; }
        .btn-secondary { background: #e8f5e9; color: #00843d; border: 1px solid #00843d; }
        .btn-secondary:hover { background: #d4f1d4; }
        .btn-danger { background: #c0152f; }
        .btn-danger:hover { background: #a01228; }
        .tree-view { max-height: 400px; overflow-y: auto; background: #f9f9f9; padding: 15px; border-radius: 4px; font-family: monospace; font-size: 12px; border: 1px solid #ddd; }
        .node { margin: 8px 0; padding: 10px; background: white; border-left: 3px solid #00843d; border-radius: 4px; cursor: pointer; transition: all 0.2s; }
        .node:hover { background: #f0f0f0; }
        .indent-1 { margin-left: 20px; }
        .indent-2 { margin-left: 40px; }
        .stats { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 15px; }
        .stat { background: #f9f9f9; padding: 15px; border-radius: 4px; text-align: center; }
        .stat-value { font-size: 24px; font-weight: bold; color: #00843d; }
        .stat-label { font-size: 12px; color: #666; margin-top: 5px; }
        .hidden { display: none !important; }
        .button-group { display: flex; gap: 10px; margin-top: 15px; }
        .button-group button { flex: 1; }
        @media (max-width: 1024px) { .grid { grid-template-columns: 1fr; } }
    </style>
</head>
<body>
    <div class="header">
        <h1>üîß Administration - Arbre de D√©cision</h1>
    </div>

    <div id="login" class="login">
        <div class="panel">
            <h2>üîê Connexion</h2>
            <input type="email" id="email" placeholder="Email" value="admin@example.com">
            <input type="password" id="password" placeholder="Mot de passe" value="admin123">
            <button onclick="login()" style="width: 100%;">Se connecter</button>
        </div>
    </div>

    <div id="admin" class="hidden">
        <div class="container">
            <div class="grid">
                <div class="panel">
                    <h2>üìä Arbre de D√©cision</h2>
                    <div class="stats">
                        <div class="stat">
                            <div class="stat-value" id="stat-nodes">0</div>
                            <div class="stat-label">N≈ìuds</div>
                        </div>
                        <div class="stat">
                            <div class="stat-value" id="stat-results">0</div>
                            <div class="stat-label">R√©sultats</div>
                        </div>
                        <div class="stat">
                            <div class="stat-value" id="stat-hors">0</div>
                            <div class="stat-label">Hors champ</div>
                        </div>
                    </div>
                    <div class="tree-view" id="tree"></div>
                    <div class="button-group">
                        <button class="btn-secondary" onclick="exportTree()">üì• Export JSON</button>
                        <button class="btn-secondary" onclick="importTree()">üì§ Import JSON</button>
                    </div>
                </div>

                <div class="panel">
                    <h2>‚úèÔ∏è √âdition</h2>
                    <input type="text" id="nodeId" placeholder="ID" readonly style="background: #f5f5f5;">
                    <input type="text" id="question" placeholder="Question">
                    <textarea id="info" placeholder="Info/Description"></textarea>
                    <div class="button-group">
                        <button onclick="saveNode()" style="flex: 2;">üíæ Enregistrer</button>
                        <button class="btn-secondary" onclick="resetForm()">‚ùå Annuler</button>
                    </div>
                    <button class="btn-danger" onclick="logout()" style="width: 100%; margin-top: 20px;">D√©connexion</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let token = localStorage.getItem('adminToken');
        let treeData = {};
        let currentNode = null;

        window.addEventListener('load', () => {
            if (token) showAdmin();
        });

        async function login() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            
            try {
                const res = await fetch('/api/admin/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password })
                });
                
                if (res.ok) {
                    const data = await res.json();
                    token = data.token;
                    localStorage.setItem('adminToken', token);
                    showAdmin();
                } else {
                    alert('Identifiants incorrects');
                }
            } catch (err) {
                alert('Erreur: ' + err.message);
            }
        }

        function showAdmin() {
            document.getElementById('login').classList.add('hidden');
            document.getElementById('admin').classList.remove('hidden');
            loadTree();
        }

        async function loadTree() {
            try {
                const res = await fetch('/api/admin/tree', {
                    headers: { 'Authorization': 'Bearer ' + token }
                });
                treeData = await res.json();
                renderTree();
                updateStats();
            } catch (err) {
                alert('Erreur: ' + err.message);
            }
        }

        function renderTree() {
            const container = document.getElementById('tree');
            container.innerHTML = '';
            renderNode('start', container, 0);
        }

        function renderNode(nodeId, container, depth) {
            if (!treeData[nodeId] || depth > 2) return;
            const node = treeData[nodeId];
            
            const div = document.createElement('div');
            div.className = 'node indent-' + Math.min(depth, 2);
            div.textContent = node.question || 'R√©sultat';
            div.style.borderLeftColor = node.horsChamp ? '#c0152f' : node.isResult ? '#21808d' : '#00843d';
            div.onclick = () => editNode(nodeId);
            container.appendChild(div);
            
            if (node.options) {
                node.options.forEach(opt => {
                    if (opt.next && treeData[opt.next]) {
                        renderNode(opt.next, container, depth + 1);
                    }
                });
            }
        }

        function editNode(nodeId) {
            currentNode = nodeId;
            const node = treeData[nodeId];
            document.getElementById('nodeId').value = nodeId;
            document.getElementById('question').value = node.question || '';
            document.getElementById('info').value = node.info || '';
        }

        async function saveNode() {
            if (!currentNode) return;
            
            treeData[currentNode].question = document.getElementById('question').value;
            treeData[currentNode].info = document.getElementById('info').value;
            
            try {
                const res = await fetch('/api/admin/tree', {
                    method: 'POST',
                    headers: {
                        'Authorization': 'Bearer ' + token,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(treeData)
                });
                
                if (res.ok) {
                    alert('‚úÖ Enregistr√©');
                    renderTree();
                } else {
                    alert('Erreur');
                }
            } catch (err) {
                alert('Erreur: ' + err.message);
            }
        }

        function resetForm() {
            document.getElementById('nodeId').value = '';
            document.getElementById('question').value = '';
            document.getElementById('info').value = '';
            currentNode = null;
        }

        function updateStats() {
            const nodes = Object.keys(treeData).length;
            const results = Object.values(treeData).filter(n => n.isResult).length;
            const hors = Object.values(treeData).filter(n => n.horsChamp).length;
            
            document.getElementById('stat-nodes').textContent = nodes;
            document.getElementById('stat-results').textContent = results;
            document.getElementById('stat-hors').textContent = hors;
        }

        function exportTree() {
            const json = JSON.stringify(treeData, null, 2);
            const blob = new Blob([json], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'tree-' + new Date().toISOString().split('T')[0] + '.json';
            a.click();
        }

        function importTree() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = async (e) => {
                const file = e.target.files[0];
                const reader = new FileReader();
                reader.onload = async (evt) => {
                    try {
                        treeData = JSON.parse(evt.target.result);
                        const res = await fetch('/api/admin/tree', {
                            method: 'POST',
                            headers: {
                                'Authorization': 'Bearer ' + token,
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(treeData)
                        });
                        if (res.ok) {
                            alert('‚úÖ Import√©');
                            renderTree();
                        }
                    } catch (err) {
                        alert('Erreur: ' + err.message);
                    }
                };
                reader.readAsText(file);
            };
            input.click();
        }

        function logout() {
            localStorage.removeItem('adminToken');
            location.reload();
        }
    </script>
</body>
</html>